<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orange Sky Network Impact</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        #visualization { width: 100vw; height: 100vh; }
        .tooltip {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            padding: 10px;
            pointer-events: none;
            max-width: 300px;
        }
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.8);
            padding: 10px;
            border-radius: 5px;
        }
        #timeline {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
        }
        #storyPanel {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 5px;
            max-width: 300px;
            max-height: 80%;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="visualization"></div>
    <div class="controls">
        <button id="playButton">Play Timeline</button>
        <select id="themeFilter">
            <option value="all">All Themes</option>
            <option value="dignity">Dignity</option>
            <option value="connection">Connection</option>
            <option value="community">Community</option>
        </select>
        <select id="roleFilter">
            <option value="all">All Roles</option>
            <option value="friend">Friends</option>
            <option value="volunteer">Volunteers</option>
            <option value="provider">Service Providers</option>
        </select>
        <button id="tourButton">Start Guided Tour</button>
    </div>
    <input type="range" id="timeline" min="2014" max="2024" value="2014" step="1">
    <div id="storyPanel"></div>
    <script>
        const width = window.innerWidth;
        const height = window.innerHeight;
        let data = { nodes: [], links: [] };
        let currentYear = 2014;
        let tourSteps = [];
        let currentTourStep = 0;

        const svg = d3.select("#visualization")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        const colorScale = d3.scaleOrdinal()
            .domain(["friend", "volunteer", "provider"])
            .range(["#FF6B6B", "#4ECDC4", "#45B7D1"]);

        const themeColorScale = d3.scaleOrdinal()
            .domain(["dignity", "connection", "community"])
            .range(["#FFD700", "#FF69B4", "#32CD32"]);

        const simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(d => d.id))
            .force("charge", d3.forceManyBody().strength(-50))
            .force("center", d3.forceCenter(width / 2, height / 2));

        d3.csv("https://acurioustractor.github.io/Orange-Sky-Stories/OS%20Stories%20-%20data.csv").then(function(csvData) {
            processData(csvData);
            drawNetwork();
            setupControls();
            createTourSteps();
        }).catch(function(error) {
            console.log("Error loading the CSV file:", error);
        });

        function processData(csvData) {
            data.nodes = csvData.map(d => ({
                id: d.Name,
                role: d.Category.toLowerCase(),
                themes: d.Tags.split(',').map(t => t.trim().toLowerCase()),
                quotes: [d['Quote 1'], d['Quote 2'], d['Quote 3'], d['Quote 4']].filter(q => q),
                year: +d.Year || 2014
            }));

            data.links = [];
            for (let i = 0; i < data.nodes.length; i++) {
                for (let j = i + 1; j < data.nodes.length; j++) {
                    if (data.nodes[i].role === data.nodes[j].role) {
                        data.links.push({ source: data.nodes[i].id, target: data.nodes[j].id });
                    }
                }
            }
        }

        function drawNetwork() {
            const link = svg.append("g")
                .selectAll("line")
                .data(data.links)
                .enter().append("line")
                .attr("stroke", "#999")
                .attr("stroke-opacity", 0.6);

            const node = svg.append("g")
                .selectAll("circle")
                .data(data.nodes)
                .enter().append("circle")
                .attr("r", 5)
                .attr("fill", d => colorScale(d.role))
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended))
                .on("mouseover", showTooltip)
                .on("mouseout", hideTooltip)
                .on("click", showStory);

            node.append("title")
                .text(d => d.id);

            simulation
                .nodes(data.nodes)
                .on("tick", ticked);

            simulation.force("link")
                .links(data.links);

            function ticked() {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);
            }
        }

        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }

        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }

        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }

        function setupControls() {
            d3.select("#playButton").on("click", playTimeline);
            d3.select("#themeFilter").on("change", filterByTheme);
            d3.select("#roleFilter").on("change", filterByRole);
            d3.select("#timeline").on("input", updateTimeline);
            d3.select("#tourButton").on("click", startTour);
        }

        function playTimeline() {
            const timeline = d3.select("#timeline");
            const endYear = +timeline.attr("max");
            let currentYear = +timeline.property("value");

            function step() {
                if (currentYear < endYear) {
                    currentYear++;
                    timeline.property("value", currentYear);
                    updateVisualization(currentYear);
                    setTimeout(step, 1000);  // Change year every second
                }
            }

            step();
        }

        function updateTimeline() {
            currentYear = +this.value;
            updateVisualization(currentYear);
        }

        function updateVisualization(year) {
            svg.selectAll("circle")
                .attr("opacity", d => d.year <= year ? 1 : 0.1)
                .attr("r", d => d.year === year ? 8 : 5);  // Highlight new nodes
        }

        function filterByTheme() {
            const theme = this.value;
            svg.selectAll("circle")
                .attr("opacity", d => theme === "all" || d.themes.includes(theme) ? 1 : 0.1)
                .attr("stroke", d => theme !== "all" && d.themes.includes(theme) ? themeColorScale(theme) : null)
                .attr("stroke-width", d => theme !== "all" && d.themes.includes(theme) ? 2 : 0);
        }

        function filterByRole() {
            const role = this.value;
            svg.selectAll("circle")
                .attr("opacity", d => role === "all" || d.role === role ? 1 : 0.1);
        }

        function showTooltip(event, d) {
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");

            tooltip.html(`
                <strong>${d.id}</strong><br>
                Role: ${d.role}<br>
                Themes: ${d.themes.join(", ")}<br>
                Year: ${d.year}<br>
                ${d.quotes.length > 0 ? `Quote: "${d.quotes[0]}"` : ""}
            `);
        }

        function hideTooltip() {
            d3.select(".tooltip").remove();
        }

        function showStory(event, d) {
            const storyPanel = d3.select("#storyPanel");
            storyPanel.html(`
                <h3>${d.id}'s Story</h3>
                <p>Role: ${d.role}</p>
                <p>Themes: ${d.themes.join(", ")}</p>
                <p>Year: ${d.year}</p>
                <h4>Quotes:</h4>
                <ul>
                    ${d.quotes.map(q => `<li>"${q}"</li>`).join("")}
                </ul>
            `);
        }

        function createTourSteps() {
            tourSteps = [
                { text: "Welcome to the Orange Sky Network Impact visualization!", action: () => {} },
                { text: "Here you can see how Orange Sky has grown since 2014.", action: () => d3.select("#timeline").property("value", 2014).dispatch("input") },
                { text: "Let's filter to show only volunteers.", action: () => d3.select("#roleFilter").property("value", "volunteer").dispatch("change") },
                { text: "Now, let's highlight connections related to dignity.", action: () => d3.select("#themeFilter").property("value", "dignity").dispatch("change") },
                { text: "Finally, let's see how the network looks in 2024.", action: () => d3.select("#timeline").property("value", 2024).dispatch("input") }
            ];
        }

        function startTour() {
            currentTourStep = 0;
            showNextTourStep();
        }

        function showNextTourStep() {
            if (currentTourStep < tourSteps.length) {
                const step = tourSteps[currentTourStep];
                alert(step.text);
                step.action();
                currentTourStep++;
            } else {
                alert("Tour completed! Feel free to explore the visualization on your own.");
            }
        }
    </script>
</body>
</html>
