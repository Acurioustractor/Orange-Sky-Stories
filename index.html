<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orange Sky Impact Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        #visualization { width: 100vw; height: 100vh; }
        .tooltip {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            padding: 10px;
            pointer-events: none;
            max-width: 200px;
        }
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.8);
            padding: 10px;
            border-radius: 5px;
        }
        #storyPanel {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 5px;
            max-width: 300px;
            max-height: 80%;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="visualization"></div>
    <div class="controls">
        <select id="themeFilter">
            <option value="all">All Themes</option>
        </select>
        <select id="roleFilter">
            <option value="all">All Roles</option>
        </select>
        <select id="locationFilter">
            <option value="all">All Locations</option>
        </select>
    </div>
    <div id="storyPanel"></div>
    <script>
        const width = window.innerWidth;
        const height = window.innerHeight;
        let data = { nodes: [], links: [] };
        let themes = [];
        let roles = ["volunteer", "friend", "service provider", "supporter"];
        let locations = [];

        const svg = d3.select("#visualization")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

        const simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(d => d.id).strength(0.1))
            .force("charge", d3.forceManyBody().strength(-100))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collide", d3.forceCollide().radius(d => d.radius + 2));

        d3.csv("https://acurioustractor.github.io/Orange-Sky-Stories/OS%20Stories%20-%20data.csv").then(function(csvData) {
            processData(csvData);
            drawNetwork();
            setupControls();
        }).catch(function(error) {
            console.log("Error loading the CSV file:", error);
        });

        function processData(csvData) {
            themes = [...new Set(csvData.flatMap(d => d.Tags.split(',').map(t => t.trim())))];
            locations = [...new Set(csvData.map(d => d.Location))];

            data.nodes = csvData.map((d, i) => ({
                id: d.Name,
                role: assignRole(d.Category),
                themes: d.Tags.split(',').map(t => t.trim()),
                location: d.Location,
                quotes: [d['Quote 1'], d['Quote 2'], d['Quote 3'], d['Quote 4']].filter(q => q),
                radius: 5 + Math.random() * 5 // Vary size based on impact (random for now)
            }));

            // Create links between nodes with shared themes
            for (let i = 0; i < data.nodes.length; i++) {
                for (let j = i + 1; j < data.nodes.length; j++) {
                    const sharedThemes = data.nodes[i].themes.filter(theme => data.nodes[j].themes.includes(theme));
                    if (sharedThemes.length > 0) {
                        data.links.push({
                            source: data.nodes[i].id,
                            target: data.nodes[j].id,
                            value: sharedThemes.length
                        });
                    }
                }
            }
        }

        function assignRole(category) {
            category = category.toLowerCase();
            if (roles.includes(category)) {
                return category;
            }
            // If the category doesn't match any of the specified roles, assign "supporter" as default
            return "supporter";
        }

        function drawNetwork() {
            const link = svg.append("g")
                .selectAll("line")
                .data(data.links)
                .enter().append("line")
                .attr("stroke-width", d => Math.sqrt(d.value))
                .attr("stroke", "#999")
                .attr("stroke-opacity", 0.6);

            const node = svg.append("g")
                .selectAll("circle")
                .data(data.nodes)
                .enter().append("circle")
                .attr("r", d => d.radius)
                .attr("fill", d => colorScale(d.role))
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended))
                .on("mouseover", showTooltip)
                .on("mouseout", hideTooltip)
                .on("click", showStory);

            node.append("title")
                .text(d => d.id);

            simulation
                .nodes(data.nodes)
                .on("tick", ticked);

            simulation.force("link")
                .links(data.links);

            function ticked() {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);
            }
        }

        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }

        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }

        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }

        function setupControls() {
            const themeFilter = d3.select("#themeFilter");
            const roleFilter = d3.select("#roleFilter");
            const locationFilter = d3.select("#locationFilter");

            themes.forEach(theme => {
                themeFilter.append("option").text(theme).attr("value", theme);
            });

            roles.forEach(role => {
                roleFilter.append("option").text(role).attr("value", role);
            });

            locations.forEach(location => {
                locationFilter.append("option").text(location).attr("value", location);
            });

            themeFilter.on("change", filterNodes);
            roleFilter.on("change", filterNodes);
            locationFilter.on("change", filterNodes);
        }

        function filterNodes() {
            const selectedTheme = d3.select("#themeFilter").property("value");
            const selectedRole = d3.select("#roleFilter").property("value");
            const selectedLocation = d3.select("#locationFilter").property("value");

            svg.selectAll("circle")
                .attr("opacity", d => {
                    const themeMatch = selectedTheme === "all" || d.themes.includes(selectedTheme);
                    const roleMatch = selectedRole === "all" || d.role === selectedRole;
                    const locationMatch = selectedLocation === "all" || d.location === selectedLocation;
                    return (themeMatch && roleMatch && locationMatch) ? 1 : 0.1;
                });

            svg.selectAll("line")
                .attr("opacity", d => {
                    const sourceVisible = svg.select(`circle[id='${d.source.id}']`).attr("opacity") == 1;
                    const targetVisible = svg.select(`circle[id='${d.target.id}']`).attr("opacity") == 1;
                    return (sourceVisible && targetVisible) ? 0.6 : 0.1;
                });
        }

        function showTooltip(event, d) {
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");

            tooltip.html(`
                <strong>${d.id}</strong><br>
                Role: ${d.role}<br>
                Themes: ${d.themes.join(", ")}<br>
                Location: ${d.location}<br>
                ${d.quotes.length > 0 ? `Quote: "${d.quotes[0]}"` : ""}
            `);
        }

        function hideTooltip() {
            d3.select(".tooltip").remove();
        }

        function showStory(event, d) {
            const storyPanel = d3.select("#storyPanel");
            storyPanel.html(`
                <h3>${d.id}'s Story</h3>
                <p>Role: ${d.role}</p>
                <p>Themes: ${d.themes.join(", ")}</p>
                <p>Location: ${d.location}</p>
                <h4>Quotes:</h4>
                <ul>
                    ${d.quotes.map(q => `<li>"${q}"</li>`).join("")}
                </ul>
            `);
        }
    </script>
</body>
</html>
